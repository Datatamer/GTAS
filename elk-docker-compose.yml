version: "3.7"

services:

  kibana:
    container_name: kibana
    build:
      context: ./gtas-parent/scripts/elastic
      dockerfile: install/docker/kibana/Dockerfile
    ports:
      - 5601:5601
    restart: always
    # secrets:
    #  - kibana_keystore
    volumes:
      - '$PWD/gtas-parent/scripts/elastic:/config/kibana'
    networks: 
      - GTAS_elastic-network
      - GTAS_webapp-network
    depends_on:
      - elasticsearch

  elasticsearch:
    container_name: elasticsearch
    build:
      context: ./gtas-parent/scripts/elastic
      dockerfile: install/docker/elasticsearch/Dockerfile
    volumes: 
      - "es-data:/usr/share/elasticsearch/data"
    restart: always
    # secrets:
    #   - elastic_keystore
    ports: 
      - 9300:9300
      - 9200:9200
    networks: 
      - GTAS_elastic-network

  logstash:
    container_name: logstash
    build:
      context: ./gtas-parent/scripts/elastic
      dockerfile: ./install/docker/logstash/Dockerfile
    environment: 
      MARIADB_HOST: 'mariadb'
      ELASTIC_HOST: 'elasticsearch'
    restart: always
    secrets:
       - source: logstash_keystore
         target: /usr/share/logstash/config/logstash.keystore
    networks:
      - GTAS_elastic-network
      - GTAS_logstash-network
    depends_on:
      - elasticsearch


secrets:
  logstash_keystore:
    file: ./gtas-parent/gtas-commons/secrets/logstash.keystore
  # elastic_keystore:
  #   file: ./gtas-parent/gtas-commons/secrets/elastic.keystore
  # kibana_keystore:
  #   file: ./gtas-parent/gtas-commons/secrets/kibana.keystore

volumes:
  es-data:
  certs:

networks:
  GTAS_elastic-network:
    driver: "bridge"
  GTAS_logstash-network:
    driver: "bridge"
  GTAS_webapp-network:
    driver: "bridge"